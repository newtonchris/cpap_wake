#!/usr/bin/python -u

import time
import datetime
import RPi.GPIO as GPIO

now = datetime.datetime.now()
time_now = (now.year, now.month, now.day, now.hour, now.minute, now.second)
print "Start run cpap_sounder.py"
print(time_now)

electric_channel = 17
channel2 = 12
GPIO.setmode(GPIO.BCM) 
GPIO.setup(electric_channel, GPIO.IN)
GPIO.setup(channel2, GPIO.OUT)
GPIO.cleanup(channel2)


time_in_high_state=0
initial_time=0
while True:
  #print "In loop"
  if GPIO.input(electric_channel):
    time_in_high_state = time_in_high_state + 1
    initial_time = initial_time + 1
    #print "No electric over .15 amps: %s" % time_in_high_state
    if time_in_high_state > 600 and initial_time > 600:
      now = datetime.datetime.now()
      time_now = (now.year, now.month, now.day, now.hour, now.minute, now.second)
      print(time_now)
      print "600 seconds have passed, sounding alarm for 30 seconds"
      print " "
      GPIO.setup(channel2, GPIO.OUT)
      time.sleep(35)
      time_in_high_state=0
      GPIO.cleanup(channel2)
    else:
      #print(time_now)
      #print "No sound in else: %s" % time_in_high_state
      test=0
  else:
    now = datetime.datetime.now()
    time_now = (now.year, now.month, now.day, now.hour, now.minute, now.second)
    print(time_now)
    print "Sensed sound: %s" % time_in_high_state
    time.sleep(1)
    time_in_high_state=0
    GPIO.cleanup(channel2)
  time.sleep(1)
